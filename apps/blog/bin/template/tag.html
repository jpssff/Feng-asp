<!--#include file="page_start.html"-->
<style type="text/css">
    #tag-table-wrap table{width:500px;}
   .td-name{width:200px;}
</style>
<dl>
    <dt>标签管理</dt>
    <dd>
        <form>
            <input type="text" name="tag_name" id="tag-add-input" value="" />
            <input type="button" value="添加标签" class="btn tag-add-btn" />
        </form>
        <div id="tag-table-wrap">loading...</div>
    </dd>
</dl>
<script type="text/javascript">
(function(){
$(function(){
    $('.tag-add-btn').click(function(){
		add($('#tag-add-input').val(), function(data){
			if(data.status == 0){
				$.tip('添加成功');
				refresh();
			}else{
				$.alert('添加失败，信息：' + data.msg);
			}
		});
    });

    $('.t-del').live('click', function(){
        var t = $(this);
        $.confirm("确定删除？", {
			ok: function(){
				remove(t.data('id'), function(){
					t.parents('tr').hide();
				});
			}
        });
        return false;
    });

    $('.t-edit').live('click', function(){
        var t = $(this);
        var td = t.parents('tr').find('.td-name');
        var input = td.find('input');
        if(input.length){
            console.log('xxx');
            input.focus();
            return false;
        }
        var name = td.text();
        input = $('<input type="text" />').val(name);
        var fn = function(e){
            var n = $.trim(input.val());
            if(n === name){
                $.tip('没有修改');
                td.text(name);
            }else{
                save(t.data('id'), n, function(){
                    td.text(n);
                })
            }
        };
        input.keydown(function(e){
            if(e.keyCode === 13)
                fn(e);
        }).blur(fn);
        td.empty().append(input);
        input.focus().select();
        return false;
    });

    refresh();
});

function add(name, fn){
	$.post('?r=admin&a=tag&action=add', {
		name:name
	}, function(data){
		fn && fn(data);
	}, 'json');
}

function save(id, name, fn){
    $.post('?r=admin&a=tag&action=save', {
        id:id,
        name:name
    }, function(data){
        if(data.status == 0){
            $.tip('保存成功');
            fn && fn();
        }else{
            $.alert('保存失败:' + data.msg);
        }
    }, 'json');
}

function remove(id, fn){
    $.post('?r=admin&a=tag&action=remove', {
        id:id
    }, function(data){
        if(data.status == 0){
            $.tip('删除成功');
            fn && fn();
        }else{
            $.alert('删除失败：' + data.msg);
        }
    }, 'json');
}

function refresh(){
    $.get('?r=admin&a=tag&action=list', function(data){
        var html = '<table class="zebra-striped"><thead><tr>' +
                '<th>编号</th><th>名称</th><th>编辑</th><th>删除</th>'+
                '</tr></thead><tbody>';
        $.each(data, function(i, v){
            html += '<tr>' + 
            '<td>' + v.id + '</td><td class="td-name">' + v.name + '</td>' +
            '<td class="td-edit"><a class="t-edit" data-id="'+ v.id+'" href="#">编辑</a></td>'+
            '<td class="td-del"><a class="t-del" data-id="'+ v.id+'" href="#">删除</a></td>'+
            '<tr>';
        });
        html += '<tbody></table>'
        var t = $('#tag-table-wrap');
        t.html(html);
    }, 'json');
}

})();
</script>
<!--#include file="page_end.html"-->

